#!/bin/bash
#
# Ensimag - Projet système
# Copyright (C) 2012 - Damien Dejean <dam.dejean@gmail.com>
#
# Creates a map that contains with a C table that contains, for each
# userspace program, its name, the address of the beginning of the program in
# physical memory, and the its length.
#
# Usage:
# ./generate-symbol-table.sh <output-file> <list of userspace binaries>

function usage() {
    printf "Script usage:"
    echo -e "\tgenerate-link-sections.sh <linker-script-output-file> <list-of-binaries>"
    echo -e "\t\t<linker-script-output-file>\tthe file where the linker script will be generated."
    echo -e "\t\t<list-of-binaires>\t\tthe list of the userspace binaries. Must contain at least one element."
}

# Check parameters requirements
if [ $# -lt 2 ]; then
    echo "*** Error: more arguments are required."
    usage
    exit 1
fi

# Get output file name, if the file already exists, quit. The makefile must
# have been cleaned it before calling us.
OUTPUT=$1
if [ -e $OUTPUT ]; then
    echo "*** Error: output file '${OUTPUT}' already exists. Remove it before calling me."
    exit 1
fi
shift

# Get files list
FILE_LIST=$@

# Create a file header
cat << EOF > $OUTPUT
/*
 * Ensimag - Projet système
 * Copyright (C) 2012 - Damien Dejean <dam.dejean@gmail.com>
 *
 * NOTE: this file is automagically generated by the build toolchain,
 * any manual modification will be losted during next build.
 *
 * Defines custom sections for each binaries and symbols to locate them.
 */
EOF

# Generate a section for each binary file, create matching symbols.
for FILE in $FILE_LIST; do

    FILE_BASE=`basename $FILE .bin`
    FILE_NAME=`basename $FILE`

    cat << EOF >> $OUTPUT
/* "${FILE_BASE}" link definition */
        _${FILE_BASE}_start = .;
        *(.${FILE_NAME})
        _${FILE_BASE}_end = .;

EOF

done

